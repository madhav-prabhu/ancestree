---
phase: 04-packaging-branding
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - build/entitlements.mac.plist
  - scripts/notarize.js
  - electron-builder.yml
  - package.json
autonomous: false
user_setup:
  - service: apple-developer
    why: "macOS code signing and notarization"
    env_vars:
      - name: APPLE_ID
        source: "Your Apple Developer account email"
      - name: APPLE_APP_SPECIFIC_PASSWORD
        source: "Apple ID -> Manage -> App-Specific Passwords -> Generate"
      - name: APPLE_TEAM_ID
        source: "Apple Developer Portal -> Membership -> Team ID"
    dashboard_config:
      - task: "Create Developer ID Application certificate"
        location: "Apple Developer Portal -> Certificates -> Create"

must_haves:
  truths:
    - "macOS build produces signed .dmg that passes Gatekeeper (when credentials provided)"
    - "Windows build produces .exe installer"
    - "Linux build produces AppImage and .deb packages"
    - "Build works without signing credentials (for development)"
  artifacts:
    - path: "build/entitlements.mac.plist"
      provides: "macOS hardened runtime entitlements"
      contains: "com.apple.security"
    - path: "scripts/notarize.js"
      provides: "macOS notarization afterSign hook"
      contains: "@electron/notarize"
    - path: "electron-builder.yml"
      provides: "afterSign hook configuration"
      contains: "afterSign"
  key_links:
    - from: "electron-builder.yml"
      to: "scripts/notarize.js"
      via: "afterSign hook"
      pattern: "afterSign.*notarize"
    - from: "electron-builder.yml"
      to: "build/entitlements.mac.plist"
      via: "entitlements path"
      pattern: "entitlements.*mac.plist"
    - from: "scripts/notarize.js"
      to: "@electron/notarize"
      via: "import"
      pattern: "require.*@electron/notarize"
---

<objective>
Set up macOS code signing infrastructure and verify packaging works for all platforms.

Purpose: Enable macOS users to install Ancestree without Gatekeeper warnings (when properly signed), and verify the complete packaging pipeline produces working installers for all platforms.

Output: macOS entitlements file, notarization script, updated electron-builder.yml with afterSign hook, and verified installers for Linux (can be tested directly) with documented process for macOS/Windows.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-packaging-branding/04-RESEARCH.md
@.planning/phases/04-packaging-branding/04-01-SUMMARY.md
@electron-builder.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create macOS entitlements and notarization script</name>
  <files>
    build/entitlements.mac.plist
    scripts/notarize.js
    electron-builder.yml
    package.json
  </files>
  <action>
1. Create build/entitlements.mac.plist for hardened runtime:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.cs.allow-jit</key>
    <true/>
    <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
    <true/>
    <key>com.apple.security.cs.allow-dyld-environment-variables</key>
    <true/>
</dict>
</plist>
```

2. Install @electron/notarize as dev dependency:
   - `npm install -D @electron/notarize`

3. Create scripts/ directory and scripts/notarize.js:

```javascript
// macOS notarization script for electron-builder afterSign hook
// Requires environment variables: APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD, APPLE_TEAM_ID

const { notarize } = require('@electron/notarize');

exports.default = async function notarizing(context) {
  const { electronPlatformName, appOutDir } = context;

  // Only notarize macOS builds
  if (electronPlatformName !== 'darwin') {
    return;
  }

  // Skip notarization if credentials not provided
  if (!process.env.APPLE_ID || !process.env.APPLE_APP_SPECIFIC_PASSWORD || !process.env.APPLE_TEAM_ID) {
    console.log('Skipping notarization: Apple credentials not provided');
    console.log('Set APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD, and APPLE_TEAM_ID to enable notarization');
    return;
  }

  const appName = context.packager.appInfo.productFilename;
  const appPath = `${appOutDir}/${appName}.app`;

  console.log(`Notarizing ${appPath}...`);

  try {
    await notarize({
      appPath,
      appleId: process.env.APPLE_ID,
      appleIdPassword: process.env.APPLE_APP_SPECIFIC_PASSWORD,
      teamId: process.env.APPLE_TEAM_ID,
    });
    console.log('Notarization complete');
  } catch (error) {
    console.error('Notarization failed:', error.message);
    throw error;
  }
};
```

4. Update electron-builder.yml to add afterSign hook (add after mac.entitlementsInherit line):
   - Add `afterSign: scripts/notarize.js` at the top level (after productName or copyright)

Note: The notarize script gracefully skips when credentials are not set, allowing development builds without Apple Developer account.
  </action>
  <verify>
- `cat build/entitlements.mac.plist | grep "com.apple.security"` shows entitlements
- `ls scripts/notarize.js` exists
- `cat scripts/notarize.js | grep "@electron/notarize"` shows import
- `cat electron-builder.yml | grep "afterSign"` shows hook configured
- `npm ls @electron/notarize` shows package installed
  </verify>
  <done>macOS entitlements file exists, notarization script handles credential presence/absence gracefully, electron-builder.yml has afterSign hook configured</done>
</task>

<task type="auto">
  <name>Task 2: Build and verify Linux installer</name>
  <files>
    dist/Ancestree-*.AppImage
    dist/ancestree_*.deb
  </files>
  <action>
1. Ensure the Electron app builds successfully:
   - `npm run build:electron`
   - This must complete without errors before packaging

2. Build Linux packages:
   - `npm run pack:linux`
   - This produces:
     - dist/Ancestree-{version}.AppImage
     - dist/ancestree_{version}_amd64.deb

3. Verify the AppImage is executable:
   - `chmod +x dist/Ancestree-*.AppImage`
   - `ls -la dist/` to confirm files exist

4. Document the dist/ output structure for the summary.

Note: Full visual verification (launching the AppImage, checking icon in dock) will be done in the checkpoint task. This task confirms the build pipeline completes successfully.
  </action>
  <verify>
- `npm run build:electron` exits with code 0
- `ls dist/*.AppImage` shows AppImage file exists
- `ls dist/*.deb` shows deb package exists
- AppImage file size is reasonable (> 50MB indicates full Electron bundle)
  </verify>
  <done>Linux packaging completes successfully, AppImage and deb files exist in dist/</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete packaging pipeline with:
- Custom application icons (generated from source)
- electron-builder configuration for all platforms
- macOS signing infrastructure (entitlements + notarization script)
- Linux installers (AppImage and .deb)
  </what-built>
  <how-to-verify>
1. **Icon verification:**
   - Check `build/icon.icns` exists (macOS icon)
   - Check `build/icon.ico` exists (Windows icon)
   - Check `build/icons/` has PNG files

2. **Linux AppImage test:**
   - Run `./dist/Ancestree-*.AppImage`
   - Verify the app launches and shows the 3D family tree
   - Check the app icon appears in your taskbar/dock (may be the placeholder "A" icon)
   - Close the app

3. **Configuration review:**
   - Review `electron-builder.yml` - should have mac, win, linux sections
   - Review `scripts/notarize.js` - should skip gracefully without credentials

4. **Expected outcomes:**
   - AppImage launches successfully on Linux
   - App shows custom icon (not default Electron icon)
   - 3D visualization works
   - Window remembers position (from Phase 3)

Note: macOS DMG and Windows NSIS builds require their respective platforms. The configuration is complete but testing those builds requires running on macOS/Windows.
  </how-to-verify>
  <resume-signal>Type "approved" if packaging works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] build/entitlements.mac.plist exists with required entitlements
- [ ] scripts/notarize.js exists and handles missing credentials gracefully
- [ ] electron-builder.yml has afterSign hook
- [ ] @electron/notarize is installed
- [ ] `npm run pack:linux` completes successfully
- [ ] AppImage file exists in dist/
- [ ] deb file exists in dist/
- [ ] User confirms AppImage runs and shows custom icon
</verification>

<success_criteria>
1. macOS signing infrastructure is complete (entitlements + notarize script + config)
2. Linux build produces working AppImage and deb packages
3. AppImage launches and shows the Ancestree 3D visualization
4. Application icon is visible (not default Electron icon)
5. Build pipeline works without signing credentials (development mode)
</success_criteria>

<output>
After completion, create `.planning/phases/04-packaging-branding/04-02-SUMMARY.md`
</output>
