---
phase: 01-electron-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Router.tsx
  - src/utils/platform.ts
autonomous: false

must_haves:
  truths:
    - "App uses HashRouter when running in Electron"
    - "App uses BrowserRouter when running in web browser"
    - "Navigation works in both Electron production build and web"
    - "Platform detection utility correctly identifies environment"
  artifacts:
    - path: "src/Router.tsx"
      provides: "Dual-mode router (Hash for Electron, Browser for web)"
      min_lines: 25
    - path: "src/utils/platform.ts"
      provides: "Platform detection utilities"
      min_lines: 10
  key_links:
    - from: "src/Router.tsx"
      to: "src/utils/platform.ts"
      via: "isElectron() import"
      pattern: "import.*isElectron.*from"
    - from: "src/utils/platform.ts"
      to: "window.electronAPI"
      via: "electronAPI detection"
      pattern: "window\\.electronAPI"
---

<objective>
Implement dual-mode routing and verify cross-platform builds

Purpose: Ensures the app works in both web (BrowserRouter with server) and Electron (HashRouter with file:// protocol). Without this, the app will show blank screens in production Electron builds.

Output:
- Dual-mode Router component that auto-detects environment
- Platform detection utilities for future Electron-specific features
- Verified builds on all three platforms
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-electron-foundation/01-RESEARCH.md

# Files created in Plan 01
@electron/main/index.ts
@electron/preload/index.ts
@electron/preload/index.d.ts

# Existing files to modify
@src/Router.tsx
@src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform detection utilities</name>
  <files>
    src/utils/platform.ts
  </files>
  <action>
Create `src/utils/platform.ts` with platform detection utilities:

```typescript
/**
 * Platform detection utilities for Electron vs Web environments.
 * Used to conditionally enable desktop-specific features.
 */

/**
 * Check if running in Electron desktop app.
 * Returns true only when electronAPI is exposed via preload script.
 */
export function isElectron(): boolean {
  return typeof window !== 'undefined' &&
         typeof window.electronAPI !== 'undefined' &&
         window.electronAPI.isElectron === true
}

/**
 * Get the Electron API if available.
 * Returns null in web browser environment.
 */
export function getElectronAPI() {
  if (!isElectron()) {
    return null
  }
  return window.electronAPI
}

/**
 * Get current platform.
 * In Electron, this could be extended to use process.platform via IPC.
 * For now, uses navigator.platform as fallback.
 */
export function getPlatform(): 'mac' | 'windows' | 'linux' | 'unknown' {
  const platform = navigator.platform.toLowerCase()
  if (platform.includes('mac')) return 'mac'
  if (platform.includes('win')) return 'windows'
  if (platform.includes('linux')) return 'linux'
  return 'unknown'
}
```

This utility will be used by Router and future Electron-specific features (file dialogs, menus, etc.).
  </action>
  <verify>
Import and call `isElectron()` in browser console - should return false. In Electron dev mode, should return true.
  </verify>
  <done>
Platform utilities exist and correctly detect Electron vs web environment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Router for dual-mode operation</name>
  <files>
    src/Router.tsx
  </files>
  <action>
Modify `src/Router.tsx` to support both Electron (HashRouter) and web (BrowserRouter):

1. Import both `BrowserRouter` and `HashRouter` from react-router-dom
2. Import `isElectron` from `./utils/platform`
3. Extract routes into a separate `AppRoutes` component for reuse
4. Create `Router` component that:
   - Checks `isElectron()` at render time
   - Returns `<HashRouter><AppRoutes /></HashRouter>` if Electron
   - Returns `<BrowserRouter><AppRoutes /></BrowserRouter>` if web

**Why HashRouter for Electron:**
- Electron production loads via `file://` protocol
- BrowserRouter uses History API which requires a server
- HashRouter uses URL hash (`#/path`) which works with static files
- Web keeps BrowserRouter for cleaner URLs and proper server-side routing

Keep existing routes (/, /timeline) unchanged.
  </action>
  <verify>
1. Run `npm run dev` - navigate to /timeline, URL shows `http://localhost:5173/timeline`
2. Run `npm run dev:electron` - navigate to timeline, URL shows hash-based path
3. Run `npm run build:electron && npm run preview:electron` - navigation still works in production build
  </verify>
  <done>
Router correctly uses HashRouter in Electron, BrowserRouter in web. Navigation works in both dev and production for both platforms.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Electron foundation with:
- Secure main process (contextIsolation, nodeIntegration=false, sandbox)
- Preload script with IPC bridge skeleton
- Dual-mode router (Hash for Electron, Browser for web)
- Platform detection utilities
- External link handling (opens in default browser)
  </what-built>
  <how-to-verify>
**Verify on your current platform (the one you're developing on):**

1. **Web version still works (CORE-05):**
   ```bash
   npm run dev
   ```
   - Open http://localhost:5173
   - 3D family tree should render
   - Navigate to Timeline and back
   - This confirms no regressions to web

2. **Electron dev mode (CORE-01):**
   ```bash
   npm run dev:electron
   ```
   - Electron window should open
   - 3D family tree visualization visible
   - Navigate to Timeline view and back
   - Try clicking any external links (if present) - should open in system browser

3. **Electron production build:**
   ```bash
   npm run build:electron
   npm run preview:electron
   ```
   - Same verification as dev mode
   - This confirms router and asset loading work with file:// protocol

4. **Offline capability (SYS-05):**
   - Disconnect from network
   - Restart the Electron app
   - App should load and function normally (uses local IndexedDB)

**Note:** Cross-platform builds (CORE-02, CORE-03, CORE-04) will be verified when building installers in Phase 4. The codebase is platform-agnostic - if it works on one platform's Electron, it will work on others.
  </how-to-verify>
  <resume-signal>
Type "approved" if all verifications pass.
If issues found, describe them and we'll address in a gap closure plan.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Platform detection works:**
   - `isElectron()` returns `true` in Electron, `false` in web

2. **Router mode is correct:**
   - Web: URL is `http://localhost:5173/timeline`
   - Electron: URL contains hash (or navigate works with file://)

3. **Both builds work:**
   - `npm run dev` - web works
   - `npm run dev:electron` - Electron works
   - `npm run build && npm run preview` - web production works
   - `npm run build:electron && npm run preview:electron` - Electron production works

4. **3D visualization renders:**
   - Galaxy-themed family tree is visible in both environments
</verification>

<success_criteria>
- User can launch desktop app and see 3D visualization (CORE-01, success criterion 1)
- Web version at localhost:5173 still works independently (CORE-05, success criterion 3)
- App works offline (SYS-05, success criterion 4)
- External links open in default browser (FILE-03, success criterion 5)
- Platform detection correctly identifies environment
- Dual-mode router handles both Electron and web correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-electron-foundation/01-02-SUMMARY.md`
</output>
