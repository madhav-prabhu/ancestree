---
phase: 01-electron-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - electron.vite.config.ts
  - electron/main/index.ts
  - electron/preload/index.ts
  - electron/preload/index.d.ts
autonomous: true

must_haves:
  truths:
    - "Electron dev server starts without errors"
    - "Main process creates a BrowserWindow"
    - "Preload script exposes electronAPI to renderer"
    - "Security settings are correctly configured (contextIsolation, nodeIntegration, sandbox)"
  artifacts:
    - path: "electron/main/index.ts"
      provides: "Main process entry with secure BrowserWindow"
      min_lines: 50
    - path: "electron/preload/index.ts"
      provides: "Secure IPC bridge skeleton via contextBridge"
      min_lines: 15
    - path: "electron/preload/index.d.ts"
      provides: "Type declarations for window.electronAPI"
      min_lines: 8
    - path: "electron.vite.config.ts"
      provides: "Unified build config for main/preload/renderer"
      min_lines: 25
  key_links:
    - from: "electron/main/index.ts"
      to: "electron/preload/index.ts"
      via: "webPreferences.preload path"
      pattern: "preload.*__dirname.*preload"
    - from: "electron/preload/index.ts"
      to: "window.electronAPI"
      via: "contextBridge.exposeInMainWorld"
      pattern: "contextBridge\\.exposeInMainWorld"
---

<objective>
Set up Electron foundation with secure main process and preload script

Purpose: Establishes the Electron runtime infrastructure that all desktop features depend on. Gets security configuration right from day one (retrofitting security is expensive).

Output:
- electron-vite config for unified builds
- Main process with secure BrowserWindow, single-instance lock, external link handling
- Preload script with empty IPC bridge ready for future features
- Package.json updated with Electron dependencies and scripts
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-electron-foundation/01-RESEARCH.md

# Existing files that inform this work
@package.json
@vite.config.ts
@src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Electron dependencies and configure electron-vite</name>
  <files>
    package.json
    electron.vite.config.ts
  </files>
  <action>
Install Electron and electron-vite tooling:

```bash
npm install -D electron electron-vite electron-builder
npm install -D @electron-toolkit/preload @electron-toolkit/utils
```

Create `electron.vite.config.ts` at project root with:
- main: Build from electron/main/index.ts, use externalizeDepsPlugin
- preload: Build from electron/preload/index.ts, use externalizeDepsPlugin
- renderer: Use existing src/ as renderer, set base: './' for file:// protocol, include react plugin

Update package.json:
- Add "main": "./out/main/index.js" at top level
- Add scripts:
  - "dev:electron": "electron-vite dev --watch"
  - "build:electron": "electron-vite build"
  - "preview:electron": "electron-vite preview"

Keep existing web scripts (dev, build, test) unchanged - web version must continue working.
  </action>
  <verify>
Run `npm run build:electron` - should complete without errors (creates out/ directory with main/preload/renderer folders). Also verify `npm run build` still works for web.
  </verify>
  <done>
electron-vite builds successfully for all three processes; web build still works; package.json has Electron scripts and main entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create main process with secure BrowserWindow</name>
  <files>
    electron/main/index.ts
  </files>
  <action>
Create `electron/main/index.ts` implementing:

1. **Single instance lock** - Prevent multiple instances (causes IndexedDB locking issues):
   - Use `app.requestSingleInstanceLock()`
   - Quit if another instance exists
   - Focus existing window on second-instance event

2. **Secure BrowserWindow creation**:
   - Size: 1200x800
   - webPreferences with ALL security settings:
     - `contextIsolation: true` (isolate preload from renderer)
     - `nodeIntegration: false` (no Node.js in renderer)
     - `sandbox: true` (OS-level sandboxing)
     - `webSecurity: true`
     - `allowRunningInsecureContent: false`
   - Preload path: `path.join(__dirname, '../preload/index.js')`
   - `show: false` initially, then show on 'ready-to-show'

3. **External link handling** (FILE-03 requirement):
   - Use `setWindowOpenHandler` to intercept new windows
   - HTTP/HTTPS URLs open via `shell.openExternal()`
   - Deny all in-app window creation
   - Also intercept `will-navigate` for navigation to external URLs

4. **Development vs production loading**:
   - Dev: Load from `process.env.ELECTRON_RENDERER_URL` (set by electron-vite)
   - Production: Load from `path.join(__dirname, '../renderer/index.html')`
   - Use `app.isPackaged` for detection

5. **Platform lifecycle handling**:
   - macOS: Re-create window on 'activate' if none exist
   - All platforms: Quit on 'window-all-closed' (except macOS)

Use ES module imports (the project is type: module).
  </action>
  <verify>
Run `npm run dev:electron` - Electron window should open showing the existing React app. Click any external links (if any in the app) - they should open in default browser, not in-app.
  </verify>
  <done>
Electron app launches and displays the 3D family tree. Security settings are all configured correctly. External links open in system browser.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create preload script with IPC bridge skeleton</name>
  <files>
    electron/preload/index.ts
    electron/preload/index.d.ts
    src/vite-env.d.ts
  </files>
  <action>
Create `electron/preload/index.ts`:

1. Import `contextBridge` and `ipcRenderer` from 'electron'

2. Create electronAPI object with:
   - `isElectron: true` - Detection flag for renderer
   - `invoke: (channel: string, ...args: unknown[]) => Promise<unknown>` - Generic IPC invoke with channel allowlist (empty for now, Phase 2 will add channels)
   - Reject with error for invalid channels

3. Expose via `contextBridge.exposeInMainWorld('electronAPI', electronAPI)`

Create `electron/preload/index.d.ts` with TypeScript declarations:
- Define `ElectronAPI` interface matching the exposed API
- Extend global `Window` interface with optional `electronAPI?: ElectronAPI`

Update `src/vite-env.d.ts` to include the Window extension so renderer TypeScript recognizes window.electronAPI.

IMPORTANT: Never expose raw ipcRenderer methods. The invoke wrapper with channel allowlist is the security pattern.
  </action>
  <verify>
In browser console of running Electron app, type `window.electronAPI` - should show object with `isElectron: true`. Type `window.electronAPI.invoke('invalid')` - should reject with "Invalid channel" error.
  </verify>
  <done>
Preload script exposes typed electronAPI to renderer. Invalid channels are rejected. TypeScript recognizes window.electronAPI in renderer code.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Electron dev mode works:**
   ```bash
   npm run dev:electron
   ```
   - Window opens with 3D family tree visible
   - HMR works (edit src/App.tsx, see changes without restart)

2. **Electron build works:**
   ```bash
   npm run build:electron
   ls out/
   ```
   - Creates out/main/, out/preload/, out/renderer/

3. **Web build still works:**
   ```bash
   npm run dev
   ```
   - Opens at localhost:5173 as before

4. **Security verified in main process:**
   - Grep electron/main/index.ts for: contextIsolation: true, nodeIntegration: false, sandbox: true
</verification>

<success_criteria>
- Electron app launches and shows 3D visualization (CORE-01)
- Security settings all correctly configured
- Web version at localhost:5173 still works (CORE-05)
- External links open in default browser (FILE-03)
- electron-vite builds succeed for all processes
- window.electronAPI exposed with isElectron flag
</success_criteria>

<output>
After completion, create `.planning/phases/01-electron-foundation/01-01-SUMMARY.md`
</output>
