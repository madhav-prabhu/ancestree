---
phase: 07-file-operations-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main/index.ts
  - electron/preload/index.ts
  - electron/preload/index.d.ts
  - src/vite-env.d.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "New menu action prompts to save if document is dirty"
    - "After user clicks Save in confirmation, New proceeds automatically"
    - "After user clicks Don't Save, New proceeds immediately"
    - "Cancel returns to current document without action"
    - "Close confirmation continues working as before"
  artifacts:
    - path: "electron/main/index.ts"
      provides: "Dirty check coordination for New action"
      contains: "pendingActionAfterSave"
    - path: "electron/preload/index.ts"
      provides: "file:proceedWithNew channel allowlist"
      contains: "file:proceedWithNew"
    - path: "src/App.tsx"
      provides: "Handler for proceedWithNew event"
      contains: "file:proceedWithNew"
  key_links:
    - from: "electron/main/index.ts"
      to: "renderer"
      via: "webContents.send('file:proceedWithNew')"
      pattern: "webContents\\.send\\('file:proceedWithNew"
    - from: "src/App.tsx"
      to: "electron/preload"
      via: "onMenuAction listener for file:proceedWithNew"
      pattern: "file:proceedWithNew"
---

<objective>
Implement dirty check for "New" menu action and save-then-continue coordination.

Purpose: Close tech debt from v1 milestone audit. Users should never lose data when creating a new document - they must be prompted to save dirty changes first.

Output: Main process shows same confirmation dialog for New as for Close. Save-then-continue flow works automatically without manual user coordination.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-file-operations-polish/07-CONTEXT.md
@.planning/phases/07-file-operations-polish/07-RESEARCH.md

Key files to modify:
@electron/main/index.ts
@electron/preload/index.ts
@electron/preload/index.d.ts
@src/vite-env.d.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file:proceedWithNew channel to preload allowlist and types</name>
  <files>
    electron/preload/index.ts
    electron/preload/index.d.ts
    src/vite-env.d.ts
  </files>
  <action>
    Add `'file:proceedWithNew'` to the ALLOWED_RECEIVE_CHANNELS array in electron/preload/index.ts.

    Update electron/preload/index.d.ts to document the new channel in the ElectronAPI interface comments.

    Update src/vite-env.d.ts to include the channel in the ElectronAPI interface comments.

    Note: The onMenuAction function already iterates over ALLOWED_RECEIVE_CHANNELS and extracts the action name by removing the prefix. The 'file:' prefix will result in action 'proceedWithNew' being passed to the callback.
  </action>
  <verify>
    Run `npm run build` - TypeScript compilation should pass with no errors.
  </verify>
  <done>
    'file:proceedWithNew' is in ALLOWED_RECEIVE_CHANNELS. Type definitions updated in both .d.ts files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend setupDirtyStateHandling() for New action coordination</name>
  <files>electron/main/index.ts</files>
  <action>
    Add module-level variable to track pending action:
    ```typescript
    let pendingActionAfterSave: 'new' | 'close' | null = null
    ```

    Create a helper function `confirmDiscardChanges()` that shows the confirmation dialog:
    - Dialog message: "Save changes?" (per CONTEXT.md)
    - Dialog detail: "Your changes will be lost if you don't save."
    - Buttons: ['Save', "Don't Save", 'Cancel']
    - defaultId: 0 (Save is primary)
    - cancelId: 2 (Cancel)
    - Returns Promise resolving to 'save' | 'discard' | 'cancel'

    Add IPC listener for 'menu:new' event that:
    1. If not dirty, return early (renderer handles immediately)
    2. Show confirmation dialog via confirmDiscardChanges()
    3. If 'save': set pendingActionAfterSave = 'new', send 'menu:save' to renderer
    4. If 'discard': reset isDirty to false, send 'file:proceedWithNew' to renderer
    5. If 'cancel': do nothing

    Add IPC handler for 'save:completed' that:
    1. If pendingActionAfterSave is 'new': send 'file:proceedWithNew' to renderer, clear pending
    2. If pendingActionAfterSave is 'close': reset isDirty, call mainWindow.close()
    3. Clear pendingActionAfterSave after handling

    Refactor existing close handler to use confirmDiscardChanges() for consistency.

    Register 'save:completed' in the invoke handler allowlist since it's a fire-and-forget notification from renderer.
  </action>
  <verify>
    Run `npm run build` - main process TypeScript compilation should pass.
  </verify>
  <done>
    Main process intercepts menu:new when dirty, shows dialog, coordinates save-then-continue flow. save:completed handler triggers pending action after successful save.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle proceedWithNew event and signal save completion in renderer</name>
  <files>src/App.tsx</files>
  <action>
    Modify the existing menu:new case in the onMenuAction switch:
    - Remove the TODO comment
    - If dirty, return early without action (main process handles dialog)
    - If not dirty, proceed with newFile + clearAll as before

    Add new case for 'proceedWithNew' in the same switch:
    - Call fileOps.newFile()
    - Call await clearAll()
    - Remove sessionStorage.removeItem('ancestree-seeded')
    - Call setSelectedMember(null)

    Modify the menu:save case to signal completion to main process:
    - After fileOps.save() returns true, call window.electronAPI!.invoke('save:completed')
    - This allows main process to trigger pending action

    Note: The onMenuAction callback receives the action name with prefix removed. 'file:proceedWithNew' becomes 'proceedWithNew'.
  </action>
  <verify>
    Run `npm run build` - full build should pass with no TypeScript errors.
  </verify>
  <done>
    App.tsx handles proceedWithNew action and signals save completion. Dirty documents show dialog before New, non-dirty proceed immediately.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run build` passes with no errors
2. `npm run lint` passes with no errors
3. `npm run test` passes (if tests exist)

Manual verification (when Electron runtime available):
- Create new document, make changes (dirty state)
- Click File > New
- Dialog appears: "Save changes?" with Save/Don't Save/Cancel
- Save: saves document, then clears to new
- Don't Save: clears to new immediately
- Cancel: returns to current document
- Close (X button) still shows same dialog and works correctly
</verification>

<success_criteria>
1. "New" menu action on dirty document shows confirmation dialog
2. "Save" in dialog triggers save, then automatically proceeds with New
3. "Don't Save" in dialog proceeds with New immediately
4. "Cancel" in dialog aborts and returns to current document
5. Existing close confirmation continues working unchanged
6. Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-file-operations-polish/07-01-SUMMARY.md`
</output>
