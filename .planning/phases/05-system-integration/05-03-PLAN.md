---
phase: 05-system-integration
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - electron/main/ipc/updateHandlers.ts
  - electron/preload/index.ts
  - electron/main/index.ts
  - electron/main/tray.ts
autonomous: true

must_haves:
  truths:
    - "Renderer can invoke update:check to trigger update check"
    - "Renderer can invoke update:download to start update download"
    - "Renderer receives update events (available, progress, downloaded, error)"
    - "Tray menu includes Check for Updates item"
    - "App checks for updates on launch (with 3 second delay)"
  artifacts:
    - path: "electron/main/ipc/updateHandlers.ts"
      provides: "IPC handlers for update:check and update:download"
      exports: ["registerUpdateHandlers"]
    - path: "electron/preload/index.ts"
      provides: "Update channels in allowlists"
      contains: "update:check"
    - path: "electron/main/tray.ts"
      provides: "Check for Updates menu item"
      contains: "Check for Updates"
  key_links:
    - from: "electron/preload/index.ts"
      to: "electron/main/ipc/updateHandlers.ts"
      via: "ALLOWED_CHANNELS includes update:check, update:download"
      pattern: "update:check.*update:download"
    - from: "electron/main/index.ts"
      to: "electron/main/updater.ts"
      via: "initAutoUpdater and checkForUpdates calls"
      pattern: "initAutoUpdater\\(mainWindow\\)"
    - from: "electron/main/tray.ts"
      to: "electron/main/updater.ts"
      via: "checkForUpdates() call from menu item"
      pattern: "checkForUpdates\\(\\)"
---

<objective>
Wire together tray, updater, and IPC to complete system integration.

Purpose: Connect all Phase 5 components so the renderer can trigger and receive update events, the tray menu includes update functionality, and updates are checked automatically on launch.

Output: Complete system integration with IPC handlers, extended preload, and full main process wiring.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-system-integration/05-CONTEXT.md
@.planning/phases/05-system-integration/05-RESEARCH.md
@.planning/phases/05-system-integration/05-01-SUMMARY.md
@.planning/phases/05-system-integration/05-02-SUMMARY.md
@electron/main/index.ts
@electron/main/tray.ts
@electron/main/updater.ts
@electron/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create update IPC handlers</name>
  <files>
    electron/main/ipc/updateHandlers.ts
  </files>
  <action>
Create IPC handlers for update operations following the existing pattern in fileHandlers.ts.

1. Create `electron/main/ipc/updateHandlers.ts`:

```typescript
import { ipcMain } from 'electron'
import { checkForUpdates, downloadUpdate } from '../updater'

/**
 * Register IPC handlers for auto-update operations
 * Called during app initialization in main/index.ts
 */
export function registerUpdateHandlers(): void {
  // Manual update check (from renderer or tray menu)
  ipcMain.handle('update:check', () => {
    checkForUpdates()
  })

  // User-initiated download (after seeing update available)
  ipcMain.handle('update:download', () => {
    downloadUpdate()
  })
}
```

Note: These handlers don't return values - the updater sends events back via webContents.send(). The handlers just trigger the operations.
  </action>
  <verify>
    npx tsc --noEmit -p electron/tsconfig.json
    # TypeScript compiles without errors
  </verify>
  <done>
    - electron/main/ipc/updateHandlers.ts exists
    - Exports registerUpdateHandlers function
    - Handles update:check and update:download channels
    - Follows same pattern as existing fileHandlers.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend preload script with update channels</name>
  <files>
    electron/preload/index.ts
  </files>
  <action>
Add update-related channels to the preload allowlists.

1. Read existing `electron/preload/index.ts`

2. Add to ALLOWED_CHANNELS (invoke channels, renderer -> main):
   ```typescript
   const ALLOWED_CHANNELS = [
     'dialog:open',
     'dialog:save',
     'dialog:saveAs',
     'dialog:export',
     'autosave:get',
     'autosave:clear',
     'autosave:has',
     'autosave:update',
     'document:setDirty',
     'document:getDirty',
     // Update channels
     'update:check',
     'update:download'
   ] as const
   ```

3. Add to ALLOWED_RECEIVE_CHANNELS (receive channels, main -> renderer):
   ```typescript
   const ALLOWED_RECEIVE_CHANNELS = [
     'menu:new',
     'menu:open',
     'menu:save',
     'menu:saveAs',
     'menu:export',
     // Update events
     'update:available',
     'update:notAvailable',
     'update:progress',
     'update:downloaded',
     'update:error'
   ] as const
   ```

4. Add a new listener method to electronAPI for update events:
   ```typescript
   /**
    * Subscribe to update events from the main process
    *
    * @param callback - Function called with event type and data
    * @returns Unsubscribe function to remove all listeners
    */
   onUpdateEvent: (callback: (event: string, data?: unknown) => void): (() => void) => {
     const updateChannels = [
       'update:available',
       'update:notAvailable',
       'update:progress',
       'update:downloaded',
       'update:error'
     ] as const

     const listeners: Array<{
       channel: string
       handler: (_event: IpcRendererEvent, data?: unknown) => void
     }> = []

     for (const channel of updateChannels) {
       const handler = (_event: IpcRendererEvent, data?: unknown): void => {
         const eventType = channel.replace('update:', '')
         callback(eventType, data)
       }
       ipcRenderer.on(channel, handler)
       listeners.push({ channel, handler })
     }

     return (): void => {
       for (const { channel, handler } of listeners) {
         ipcRenderer.removeListener(channel, handler)
       }
     }
   }
   ```

This follows the same pattern as onMenuAction but for update events.
  </action>
  <verify>
    npx tsc --noEmit -p electron/tsconfig.json
    grep "update:check" electron/preload/index.ts
    grep "update:available" electron/preload/index.ts
    # Both channels should appear in the file
  </verify>
  <done>
    - ALLOWED_CHANNELS includes update:check and update:download
    - ALLOWED_RECEIVE_CHANNELS includes all update event channels
    - onUpdateEvent method added to electronAPI following onMenuAction pattern
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire everything into main process and update tray</name>
  <files>
    electron/main/index.ts
    electron/main/tray.ts
  </files>
  <action>
Complete the main process wiring and add Check for Updates to tray menu.

**Part A: Update electron/main/index.ts**

1. Add imports:
   ```typescript
   import { registerUpdateHandlers } from './ipc/updateHandlers'
   import { initAutoUpdater, checkForUpdates } from './updater'
   ```

2. In `app.whenReady()`, add after existing handler registrations:
   ```typescript
   // Register IPC handlers before creating windows
   registerFileHandlers()
   registerAutoSaveHandlers()
   registerUpdateHandlers()  // ADD THIS
   ```

3. After `createTray(mainWindow)`, add updater initialization:
   ```typescript
   // Initialize auto-updater
   if (mainWindow) {
     initAutoUpdater(mainWindow)
   }

   // Check for updates on launch (per CONTEXT.md: on launch)
   // Delay to not block startup
   setTimeout(() => {
     checkForUpdates()
   }, 3000)
   ```

**Part B: Update electron/main/tray.ts**

1. Add import at top:
   ```typescript
   import { checkForUpdates } from './updater'
   ```

2. Update `buildContextMenu()` to include Check for Updates:
   ```typescript
   function buildContextMenu(mainWindow: BrowserWindow): Menu {
     const menuItems: Electron.MenuItemConstructorOptions[] = []

     // Show current file in menu header
     if (currentFilename) {
       menuItems.push(
         { label: currentFilename, enabled: false },
         { type: 'separator' }
       )
     }

     menuItems.push(
       {
         label: 'Show Window',
         click: () => {
           mainWindow.show()
           mainWindow.focus()
         }
       },
       {
         label: 'Check for Updates',
         click: () => {
           checkForUpdates()
         }
       },
       { type: 'separator' },
       {
         label: 'Quit',
         click: () => {
           app.quit()
         }
       }
     )

     return Menu.buildFromTemplate(menuItems)
   }
   ```

The menu structure now matches CONTEXT.md: [Current File] > Show Window > Check for Updates > Quit
  </action>
  <verify>
    npm run build:electron
    grep "registerUpdateHandlers" electron/main/index.ts
    grep "initAutoUpdater" electron/main/index.ts
    grep "Check for Updates" electron/main/tray.ts
    # All patterns should be found, build should succeed
  </verify>
  <done>
    - registerUpdateHandlers() called in app.whenReady()
    - initAutoUpdater(mainWindow) called after tray creation
    - checkForUpdates() called with 3 second delay on launch
    - Tray menu includes "Check for Updates" item
    - Tray menu structure matches CONTEXT.md specification
    - Build completes successfully
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build: `npm run build:electron` passes
2. Type check: `npx tsc --noEmit -p electron/tsconfig.json` passes
3. IPC wiring:
   - `grep "update:check" electron/preload/index.ts` shows channel in allowlist
   - `grep "registerUpdateHandlers" electron/main/index.ts` shows handler registration
4. Tray: `grep "Check for Updates" electron/main/tray.ts` shows menu item

Full integration test checklist (for manual testing when runtime available):
- [ ] App launches and shows tray icon
- [ ] Tray menu shows: [filename if set] > Show Window > Check for Updates > Quit
- [ ] macOS: clicking tray shows menu
- [ ] Windows/Linux: clicking tray toggles window
- [ ] "Check for Updates" triggers update check (see console in dev)
- [ ] Update events flow to renderer (if update available from GitHub)
</verification>

<success_criteria>
- Update IPC handlers registered and working
- Preload script allows update:check, update:download invoke channels
- Preload script allows all update event receive channels
- onUpdateEvent method added to electronAPI
- Main process initializes updater after window and tray creation
- Update check runs 3 seconds after launch
- Tray menu includes "Check for Updates" item
- All components wired together correctly
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-system-integration/05-03-SUMMARY.md`
</output>
