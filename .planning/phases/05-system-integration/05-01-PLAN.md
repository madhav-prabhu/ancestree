---
phase: 05-system-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - build/icons/tray/iconTemplate.png
  - build/icons/tray/iconTemplate@2x.png
  - build/icons/tray/icon.ico
  - build/icons/tray/icon.png
  - electron/main/tray.ts
  - electron/main/index.ts
autonomous: true

must_haves:
  truths:
    - "System tray icon appears when app is running"
    - "Tray context menu shows current filename, Show Window, and Quit"
    - "macOS: clicking tray shows menu; Windows/Linux: clicking toggles window"
  artifacts:
    - path: "build/icons/tray/iconTemplate.png"
      provides: "macOS tray icon (16x16, black + alpha)"
    - path: "build/icons/tray/iconTemplate@2x.png"
      provides: "macOS tray icon retina (32x32, black + alpha)"
    - path: "build/icons/tray/icon.ico"
      provides: "Windows tray icon (multi-resolution ICO)"
    - path: "build/icons/tray/icon.png"
      provides: "Linux tray icon (22x22 PNG)"
    - path: "electron/main/tray.ts"
      provides: "Tray module with createTray, updateTrayMenu, setCurrentFilename, destroyTray exports"
      exports: ["createTray", "updateTrayMenu", "setCurrentFilename", "destroyTray"]
  key_links:
    - from: "electron/main/index.ts"
      to: "electron/main/tray.ts"
      via: "createTray(mainWindow) call in app.whenReady()"
      pattern: "createTray\\(mainWindow\\)"
    - from: "electron/main/tray.ts"
      to: "build/icons/tray/*"
      via: "nativeImage.createFromPath with platform-conditional paths"
      pattern: "nativeImage\\.createFromPath"
---

<objective>
Implement system tray icon with context menu for Ancestree desktop app.

Purpose: Users can see Ancestree in system tray and access quick actions (show window, quit) without bringing window to focus. This provides persistent desktop presence and convenient access.

Output: Platform-specific tray icons and tray module integrated into main process.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-system-integration/05-CONTEXT.md
@.planning/phases/05-system-integration/05-RESEARCH.md
@electron/main/index.ts
@electron/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform-specific tray icons</name>
  <files>
    build/icons/tray/iconTemplate.png
    build/icons/tray/iconTemplate@2x.png
    build/icons/tray/icon.ico
    build/icons/tray/icon.png
    scripts/create-tray-icons.mjs
  </files>
  <action>
Create tray icons for all platforms using sharp (already installed as devDependency).

1. Create `scripts/create-tray-icons.mjs`:
   - Read source icon from `assets/icon-source.png` (exists, 1024x1024)
   - Create `build/icons/tray/` directory

2. Generate macOS Template icons:
   - `iconTemplate.png`: 16x16, convert to grayscale, use only black (#000000) with alpha channel
   - `iconTemplate@2x.png`: 32x32, same treatment
   - CRITICAL: macOS template images MUST be black + alpha only (no colors). The "Template" suffix tells macOS to auto-invert for dark mode

3. Generate Windows ICO:
   - `icon.ico`: Multi-resolution ICO containing 16x16, 24x24, 32x32, 48x48 sizes
   - Use sharp to create individual PNGs, then combine with ico-endec or write raw ICO format
   - Alternative: Use toBuffer({ resolveWithObject: true }) and manually write ICO header

4. Generate Linux PNG:
   - `icon.png`: 22x22 PNG (standard size for GNOME/Unity tray)

5. Add npm script: `"icons:tray": "node scripts/create-tray-icons.mjs"`

6. Run the script to generate all icons

Note: For Windows ICO, if ico-endec is complex, generate a 32x32 PNG and rename to .ico (Electron accepts this, though not ideal). Better: use sharp's existing .ico support if available, or a simple ICO writer.
  </action>
  <verify>
    ls -la build/icons/tray/
    # Should show: iconTemplate.png, iconTemplate@2x.png, icon.ico, icon.png
    file build/icons/tray/*
    # Verify image formats and sizes
  </verify>
  <done>
    - build/icons/tray/ directory contains 4 icon files
    - iconTemplate.png is 16x16 grayscale PNG
    - iconTemplate@2x.png is 32x32 grayscale PNG
    - icon.ico exists and is valid ICO format
    - icon.png is 22x22 PNG
    - npm run icons:tray regenerates all icons without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tray module with context menu</name>
  <files>
    electron/main/tray.ts
  </files>
  <action>
Create the tray module following the pattern from 05-RESEARCH.md.

1. Create `electron/main/tray.ts` with:
   - Module-level `tray: Tray | null = null` to prevent garbage collection
   - Module-level `currentFilename: string | null = null` for menu header

2. `getIconPath()` function:
   - macOS: Return `path.join(__dirname, '../../build/icons/tray/iconTemplate.png')`
   - Windows: Return `path.join(__dirname, '../../build/icons/tray/icon.ico')`
   - Linux: Return `path.join(__dirname, '../../build/icons/tray/icon.png')`
   - Note: `__dirname` in compiled output is `out/main/`, so `../../build/` reaches project root

3. `buildContextMenu(mainWindow: BrowserWindow)` function:
   - If currentFilename set: Add disabled label showing filename, then separator
   - Add "Show Window" item: `mainWindow.show(); mainWindow.focus()`
   - Add separator
   - Add "Quit" item: `app.quit()`
   - Return `Menu.buildFromTemplate(menuItems)`
   - Note: "Check for Updates" will be added in Plan 03 after updater exists

4. `createTray(mainWindow: BrowserWindow)` export:
   - Create nativeImage from getIconPath()
   - Create new Tray(icon)
   - Set tooltip: 'Ancestree'
   - Set context menu via buildContextMenu()
   - Platform click behavior (per CONTEXT.md):
     - macOS: No click handler (clicking shows menu by default)
     - Windows/Linux: Add 'click' event that toggles window visibility

5. `updateTrayMenu(mainWindow: BrowserWindow)` export:
   - Rebuild and set context menu (for Linux compatibility - must rebuild entire menu)

6. `setCurrentFilename(filename: string | null)` export:
   - Update module-level currentFilename
   - Note: Caller should call updateTrayMenu after to reflect change

7. `destroyTray()` export:
   - If tray exists, call tray.destroy() and set to null
  </action>
  <verify>
    npx tsc --noEmit -p electron/tsconfig.json
    # TypeScript compiles without errors
  </verify>
  <done>
    - electron/main/tray.ts exists with all exports
    - TypeScript compiles without errors
    - Module stores tray reference globally (garbage collection prevention)
    - Platform-specific icon paths use correct paths relative to compiled output
    - Click behavior differs by platform (macOS menu, others toggle)
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate tray into main process</name>
  <files>
    electron/main/index.ts
  </files>
  <action>
Wire tray module into main process initialization.

1. Add imports at top of `electron/main/index.ts`:
   ```typescript
   import { createTray, destroyTray, setCurrentFilename, updateTrayMenu } from './tray'
   ```

2. In `app.whenReady()` after `createApplicationMenu(mainWindow)`:
   ```typescript
   // Create system tray
   if (mainWindow) {
     createTray(mainWindow)
   }
   ```

3. Update dirty state handler to also update tray filename:
   - In the `ipcMain.handle('document:setDirty', ...)` handler, after setting window title:
   ```typescript
   // Update tray menu with current filename
   setCurrentFilename(filePath ? path.basename(filePath) : null)
   if (mainWindow) {
     updateTrayMenu(mainWindow)
   }
   ```

4. In `app.on('before-quit', ...)`:
   ```typescript
   stopAutoSave()
   destroyTray()
   ```

5. Ensure tray is cleaned up on window close (in mainWindow 'closed' event):
   - Already handles cleanupWindowState, add destroyTray() there too
  </action>
  <verify>
    npm run build:electron
    # Build should complete without errors
  </verify>
  <done>
    - Tray imports added to main/index.ts
    - createTray called after window and menu creation
    - Tray filename updates when document dirty state changes
    - Tray destroyed on app quit and window close
    - Build completes successfully
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build: `npm run build:electron` passes
2. Icons exist: `ls build/icons/tray/` shows 4 files
3. Type check: `npx tsc --noEmit -p electron/tsconfig.json` passes

Note: Runtime testing requires Node.js v20/v22 LTS (see STATE.md blockers about Node.js v24 incompatibility). The code can be verified structurally but runtime testing may be deferred.
</verification>

<success_criteria>
- System tray icon files exist for macOS (Template), Windows (ICO), and Linux (PNG)
- Tray module exports createTray, updateTrayMenu, setCurrentFilename, destroyTray
- Main process creates tray on startup and destroys on quit
- Context menu shows current filename (when set), Show Window, and Quit
- Platform-specific click behavior implemented (macOS menu, others toggle)
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-system-integration/05-01-SUMMARY.md`
</output>
