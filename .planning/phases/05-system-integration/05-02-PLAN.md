---
phase: 05-system-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - electron/main/updater.ts
  - electron-builder.yml
autonomous: true

must_haves:
  truths:
    - "electron-updater is installed as a dependency"
    - "Updater module configures autoDownload: false for user-controlled downloads"
    - "Updater module configures autoInstallOnAppQuit: true for install-on-quit"
    - "electron-builder.yml has GitHub Releases publish configuration"
  artifacts:
    - path: "package.json"
      provides: "electron-updater dependency"
      contains: "electron-updater"
    - path: "electron/main/updater.ts"
      provides: "Auto-updater initialization and event handling"
      exports: ["initAutoUpdater", "checkForUpdates", "downloadUpdate"]
    - path: "electron-builder.yml"
      provides: "GitHub Releases publish configuration"
      contains: "provider: github"
  key_links:
    - from: "electron/main/updater.ts"
      to: "electron-updater"
      via: "import { autoUpdater } from 'electron-updater'"
      pattern: "import.*autoUpdater.*from.*electron-updater"
    - from: "electron/main/updater.ts"
      to: "BrowserWindow.webContents.send"
      via: "IPC events for update status"
      pattern: "webContents\\.send\\('update:"
---

<objective>
Implement auto-updater module using electron-updater with GitHub Releases as the update server.

Purpose: Enable automatic update checking on launch with user-controlled downloads. Updates install silently on app quit, providing seamless updates without disrupting user workflow.

Output: electron-updater installed, updater module created, and electron-builder configured for GitHub Releases publishing.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-system-integration/05-CONTEXT.md
@.planning/phases/05-system-integration/05-RESEARCH.md
@package.json
@electron-builder.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install electron-updater dependency</name>
  <files>
    package.json
  </files>
  <action>
Install electron-updater as a runtime dependency.

1. Run: `npm install electron-updater`
   - This installs electron-updater (bundled with electron-builder but needs explicit install for imports)
   - Should be in dependencies, not devDependencies (needed at runtime)

2. Verify package.json shows electron-updater in dependencies

Note: electron-log is optional (recommended in RESEARCH.md for debugging). Skip for now - can add later if update debugging becomes necessary.
  </action>
  <verify>
    grep "electron-updater" package.json
    # Should show electron-updater in dependencies
  </verify>
  <done>
    - electron-updater appears in package.json dependencies
    - npm install completes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create updater module</name>
  <files>
    electron/main/updater.ts
  </files>
  <action>
Create the auto-updater module following patterns from 05-RESEARCH.md.

1. Create `electron/main/updater.ts` with:

2. Imports:
   ```typescript
   import { autoUpdater, UpdateInfo, ProgressInfo } from 'electron-updater'
   import { BrowserWindow, Notification, app } from 'electron'
   ```

3. Module-level state:
   ```typescript
   let mainWindow: BrowserWindow | null = null
   ```

4. `initAutoUpdater(win: BrowserWindow)` export:
   - Store mainWindow reference
   - Configure autoUpdater:
     - `autoUpdater.autoDownload = false` (per CONTEXT.md: user clicks "Download")
     - `autoUpdater.autoInstallOnAppQuit = true` (per CONTEXT.md: install on quit)

5. Event handlers (all within initAutoUpdater):

   a. `autoUpdater.on('update-available', (info: UpdateInfo))`:
      - Show OS notification (per CONTEXT.md: native, non-blocking)
        ```typescript
        if (Notification.isSupported()) {
          const notification = new Notification({
            title: 'Update Available',
            body: `Ancestree ${info.version} is available.`,
            silent: false
          })
          notification.on('click', () => {
            mainWindow?.show()
            mainWindow?.focus()
          })
          notification.show()
        }
        ```
      - Send to renderer: `mainWindow?.webContents.send('update:available', { version: info.version, releaseNotes: info.releaseNotes })`

   b. `autoUpdater.on('update-not-available', ())`:
      - Send to renderer: `mainWindow?.webContents.send('update:notAvailable')`

   c. `autoUpdater.on('download-progress', (progress: ProgressInfo))`:
      - Send progress to renderer: `mainWindow?.webContents.send('update:progress', { percent: progress.percent, transferred: progress.transferred, total: progress.total })`
      - Show taskbar progress (per CONTEXT.md): `mainWindow?.setProgressBar(progress.percent / 100)`

   d. `autoUpdater.on('update-downloaded', ())`:
      - Clear taskbar progress: `mainWindow?.setProgressBar(-1)`
      - Send to renderer: `mainWindow?.webContents.send('update:downloaded')`
      - Show notification: "Update Ready - The update will be installed when you quit Ancestree."

   e. `autoUpdater.on('error', (error: Error))`:
      - Send to renderer: `mainWindow?.webContents.send('update:error', error.message)`
      - Clear taskbar progress: `mainWindow?.setProgressBar(-1)`

6. `checkForUpdates()` export:
   - Guard with `if (!app.isPackaged)` - skip in development (see RESEARCH.md pitfall)
   - Call `autoUpdater.checkForUpdates()`

7. `downloadUpdate()` export:
   - Call `autoUpdater.downloadUpdate()`

Note: No quitAndInstall() export needed - CONTEXT.md specifies autoInstallOnAppQuit pattern.
  </action>
  <verify>
    npx tsc --noEmit -p electron/tsconfig.json
    # TypeScript compiles without errors
  </verify>
  <done>
    - electron/main/updater.ts exists with initAutoUpdater, checkForUpdates, downloadUpdate exports
    - autoDownload set to false
    - autoInstallOnAppQuit set to true
    - All autoUpdater events handled and forwarded via IPC
    - Development mode guard on checkForUpdates
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add GitHub Releases publish configuration</name>
  <files>
    electron-builder.yml
  </files>
  <action>
Add publish configuration for GitHub Releases to electron-builder.yml.

1. Read existing electron-builder.yml
2. Add publish section at the end (before any trailing comments):

```yaml
# Auto-update configuration
publish:
  provider: github
  owner: ${GH_OWNER}
  repo: ancestree
  releaseType: release
```

Note: Using environment variable ${GH_OWNER} for flexibility. Users will set GH_OWNER when publishing. Alternatively, if the repo owner is known, hardcode it.

Alternative if hardcoding is preferred (check if there's a known owner):
```yaml
publish:
  provider: github
  repo: ancestree
  releaseType: release
```
(Without owner, electron-builder derives from git remote or package.json repository)

3. Keep releaseType as 'release' (not 'draft') so updates are immediately available.

The publish configuration enables:
- electron-builder to generate update metadata files (latest.yml, latest-mac.yml, latest-linux.yml)
- electron-updater to check GitHub Releases for updates
  </action>
  <verify>
    grep -A 4 "publish:" electron-builder.yml
    # Should show provider: github configuration
  </verify>
  <done>
    - electron-builder.yml contains publish section with provider: github
    - releaseType set to 'release' for immediate update availability
    - Configuration will generate update metadata files during build
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Dependencies: `npm ls electron-updater` shows installed version
2. Type check: `npx tsc --noEmit -p electron/tsconfig.json` passes
3. Build config: `grep -A 4 "publish:" electron-builder.yml` shows github provider

Note: Actual update functionality requires a published GitHub Release to test. The code structure can be verified but end-to-end testing requires publishing.
</verification>

<success_criteria>
- electron-updater installed as runtime dependency
- Updater module has initAutoUpdater, checkForUpdates, downloadUpdate exports
- autoDownload=false and autoInstallOnAppQuit=true configured
- All update events (available, progress, downloaded, error) forwarded via IPC
- OS-native notifications shown for update-available and update-downloaded
- Taskbar progress bar updated during download
- Development mode guard prevents update checks in dev
- electron-builder.yml has GitHub Releases publish configuration
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-system-integration/05-02-SUMMARY.md`
</output>
