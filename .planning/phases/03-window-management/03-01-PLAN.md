---
phase: 03-window-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main/services/windowState.ts
  - electron/main/index.ts
autonomous: true

must_haves:
  truths:
    - "User restarts app and window appears at same size and position as before"
    - "First launch opens centered window at 80% screen size"
    - "Window remembers position after manual resize or move"
    - "Disconnected monitor scenario recovers to default position"
    - "Window has platform-native title bar (not custom frameless)"
    - "Minimize, maximize, and close buttons work correctly on each platform"
  artifacts:
    - path: "electron/main/services/windowState.ts"
      provides: "Window state persistence service"
      exports: ["loadWindowState", "trackWindowState", "getMinimumDimensions"]
    - path: "electron/main/index.ts"
      provides: "Window creation with persisted bounds"
      contains: "loadWindowState"
  key_links:
    - from: "electron/main/index.ts"
      to: "electron/main/services/windowState.ts"
      via: "import and call loadWindowState/trackWindowState"
      pattern: "loadWindowState|trackWindowState"
    - from: "electron/main/services/windowState.ts"
      to: "electron-store"
      via: "Store instance for bounds persistence"
      pattern: "new Store"
---

<objective>
Implement window state persistence so the app window remembers its size and position across restarts.

Purpose: Users expect desktop apps to open where they left them. This is table-stakes native behavior.
Output: WindowStateManager service and updated main process that persists/restores window bounds.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-window-management/03-CONTEXT.md
@.planning/phases/03-window-management/03-RESEARCH.md
@electron/main/index.ts
@electron/main/services/autoSave.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WindowStateManager service</name>
  <files>electron/main/services/windowState.ts</files>
  <action>
Create WindowStateManager service following the pattern from 03-RESEARCH.md.

Implementation details:
- Create `electron/main/services/windowState.ts`
- Interface `WindowBounds { x, y, width, height }` for type safety
- Interface `WindowStateSchema { bounds: WindowBounds | null }` for electron-store
- Constants: MIN_WIDTH=400, MIN_HEIGHT=300, DEFAULT_SIZE_PERCENT=0.8, SAVE_DEBOUNCE_MS=500
- electron-store instance with name `ancestree-window-state`

Functions to implement:
1. `getDefaultBounds()`: Calculate 80% of primary display workArea, centered
2. `isPositionVisible(x, y)`: Check if point is on any connected display via screen.getAllDisplays()
3. `validateBounds(bounds)`: Check min dimensions + position visible, return null if invalid
4. `debouncedSave(bounds)`: Debounce with clearTimeout/setTimeout pattern (500ms), log in dev only
5. `loadWindowState()`: Try to load from store, validate, fallback to defaults. Wrap in try/catch for corrupted state.
6. `trackWindowState(window)`: Listen to resize/move events, call debouncedSave if not maximized/fullscreen. Return cleanup function.
7. `getMinimumDimensions()`: Return { minWidth: MIN_WIDTH, minHeight: MIN_HEIGHT }

Export: loadWindowState, trackWindowState, getMinimumDimensions

Follow autoSave.ts patterns for electron-store usage. Use `app.isPackaged` for conditional logging (opposite of !app.isPackaged for dev-only logs).
  </action>
  <verify>
File exists at `electron/main/services/windowState.ts` with all exports:
```bash
cat electron/main/services/windowState.ts | grep -E "^export (function|const)"
```
Expected: loadWindowState, trackWindowState, getMinimumDimensions
  </verify>
  <done>
WindowState service created with loadWindowState(), trackWindowState(), and getMinimumDimensions() exports. Uses electron-store for persistence, validates positions against displays, debounces saves at 500ms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WindowState into main process</name>
  <files>electron/main/index.ts</files>
  <action>
Modify electron/main/index.ts to use the new WindowStateManager.

Changes to createWindow():
1. Add import: `import { loadWindowState, trackWindowState, getMinimumDimensions } from './services/windowState'`
2. Call `const bounds = loadWindowState()` before creating BrowserWindow
3. Call `const { minWidth, minHeight } = getMinimumDimensions()`
4. Update BrowserWindow options:
   - Replace `width: 1200, height: 800` with `x: bounds.x, y: bounds.y, width: bounds.width, height: bounds.height`
   - Add `minWidth, minHeight` options (no maxWidth/maxHeight per user decision)
5. After creating window, call `const cleanupWindowState = trackWindowState(mainWindow)`
6. In the 'closed' event handler, call `cleanupWindowState()` before setting mainWindow to null

IMPORTANT: Do NOT set `frame: false` or `titleBarStyle: 'hidden'` in BrowserWindow options. Electron uses the platform-native frame by default, which provides the standard title bar with minimize, maximize, and close buttons. This is the correct behavior for a native desktop experience.

Keep all existing security settings (contextIsolation, nodeIntegration, sandbox, etc) unchanged.
Keep all existing handlers (external links, navigation interception, etc) unchanged.
  </action>
  <verify>
Build succeeds and app launches:
```bash
cd /home/madhav/projects/ancestree && npm run build
```
App should open with window positioned and sized correctly.
  </verify>
  <done>
Main process uses WindowStateManager for window creation. Window opens at persisted bounds (or centered 80% on first launch), tracks resize/move events, and cleans up on close. Native frame is preserved (no frameless window options).
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify persistence and native window behavior</name>
  <files></files>
  <action>
Verify window state persistence and native window controls work correctly:

**Part A: Window State Persistence**
1. Launch the app (first time after changes)
2. Observe: Window should open centered at ~80% of screen size
3. Resize and move the window to a specific position
4. Close the app
5. Relaunch the app
6. Observe: Window should appear at the same size and position

**Part B: Native Window Controls**
7. Verify the window has a platform-native title bar (should look like other native apps on your OS)
8. Click the **minimize** button — window should minimize to taskbar/dock
9. Click the app icon in taskbar/dock to restore — window should reappear
10. Click the **maximize** button — window should fill the screen (or enter macOS full-screen mode)
11. Click maximize/restore again — window should return to previous size
12. Click the **close** button — app should close cleanly

**Part C: Size Constraints**
13. Try to resize window smaller than 400x300 — should be blocked by minimum size constraints

Document the verification results in the summary.
  </action>
  <verify>
Run the app and manually verify all behaviors:
```bash
cd /home/madhav/projects/ancestree && npm run dev
```
Test sequence:
- Part A: Move window -> Close -> Reopen -> Verify position restored
- Part B: Test minimize, maximize/restore, and close buttons
- Part C: Verify minimum size constraint
  </verify>
  <done>
Window state persists across app restarts. First launch shows centered 80% window. Subsequent launches restore saved position/size. Native title bar displayed with working minimize, maximize, and close buttons. Minimum size enforced at 400x300.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes (TypeScript compilation succeeds)
2. Window opens at saved position on subsequent launches
3. First launch opens centered at ~80% of screen size
4. Minimum window size (400x300) is enforced
5. No errors in console when resizing/moving window
6. Window has platform-native title bar (not custom frameless)
7. Minimize, maximize, and close buttons work correctly
</verification>

<success_criteria>
- WindowStateManager service exists at electron/main/services/windowState.ts
- Main process imports and uses WindowStateManager
- Window position/size persists across app restarts
- First launch shows centered, appropriately-sized window
- Build passes without TypeScript errors
- Window has platform-native title bar (not custom frameless)
- Minimize, maximize, and close buttons work as expected on each platform
</success_criteria>

<output>
After completion, create `.planning/phases/03-window-management/03-01-SUMMARY.md`
</output>
