---
phase: 06-update-ui-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/preload/index.d.ts
  - src/vite-env.d.ts
  - src/hooks/useUpdateEvents.ts
  - src/components/UpdateNotification.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "onUpdateEvent method is properly typed in ElectronAPI interface"
    - "Renderer can subscribe to update events without TypeScript errors"
    - "In-app notification appears when update is available"
    - "User can trigger download from in-app UI"
  artifacts:
    - path: "electron/preload/index.d.ts"
      provides: "Type definition for onUpdateEvent"
      contains: "onUpdateEvent"
    - path: "src/vite-env.d.ts"
      provides: "Type definition for onUpdateEvent (renderer copy)"
      contains: "onUpdateEvent"
    - path: "src/hooks/useUpdateEvents.ts"
      provides: "React hook for update event subscription"
      exports: ["useUpdateEvents"]
    - path: "src/components/UpdateNotification.tsx"
      provides: "In-app update notification UI"
      exports: ["UpdateNotification"]
  key_links:
    - from: "src/hooks/useUpdateEvents.ts"
      to: "window.electronAPI.onUpdateEvent"
      via: "event subscription"
      pattern: "onUpdateEvent\\("
    - from: "src/components/UpdateNotification.tsx"
      to: "src/hooks/useUpdateEvents.ts"
      via: "hook import"
      pattern: "useUpdateEvents"
    - from: "src/App.tsx"
      to: "src/components/UpdateNotification.tsx"
      via: "component import and render"
      pattern: "<UpdateNotification"
---

<objective>
Add TypeScript type definitions for `onUpdateEvent` and create an in-app update notification component.

Purpose: Close the gap where `onUpdateEvent` is implemented in preload but lacks types, and provide in-app update UI instead of relying solely on OS notifications.

Output:
- Type definitions in both type declaration files
- `useUpdateEvents` hook for event subscription
- `UpdateNotification` component with download progress
- Integration in App.tsx
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-update-ui-completion/06-RESEARCH.md

# Existing patterns to follow
@electron/preload/index.ts
@electron/preload/index.d.ts
@src/vite-env.d.ts
@src/App.tsx
@src/utils/platform.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onUpdateEvent type definitions</name>
  <files>electron/preload/index.d.ts, src/vite-env.d.ts</files>
  <action>
Add the `onUpdateEvent` method to the `ElectronAPI` interface in BOTH files. The type signature must match exactly:

```typescript
onUpdateEvent: (callback: (event: string, data?: unknown) => void) => () => void
```

In `electron/preload/index.d.ts`:
- Add the method to the existing `ElectronAPI` interface after `onMenuAction`
- Include JSDoc comment explaining the method purpose

In `src/vite-env.d.ts`:
- Add the same method to the `ElectronAPI` interface after `onMenuAction`
- Include brief JSDoc comment

IMPORTANT: Both files MUST have identical type signatures. The preload definition is the source of truth but both must be updated together. The implementation already exists in `electron/preload/index.ts:103-137`.
  </action>
  <verify>
Run `npm run build` - should pass without TypeScript errors related to `onUpdateEvent`.
  </verify>
  <done>
Both type declaration files include `onUpdateEvent` method with matching signatures. TypeScript recognizes `window.electronAPI?.onUpdateEvent` without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useUpdateEvents hook</name>
  <files>src/hooks/useUpdateEvents.ts</files>
  <action>
Create a new hook that subscribes to update events and exposes state + actions.

Follow the existing pattern from App.tsx's `onMenuAction` usage (lines 88-155).

Interface for state:
```typescript
interface UpdateState {
  status: 'idle' | 'checking' | 'available' | 'downloading' | 'ready' | 'error'
  version?: string
  progress?: number
  error?: string
}
```

Hook implementation:
1. Use `useState` for `UpdateState`, initialize with `{ status: 'idle' }`
2. Use `useEffect` with `isElectron()` guard to subscribe to `window.electronAPI!.onUpdateEvent`
3. Handle events: 'available', 'notAvailable', 'progress', 'downloaded', 'error'
4. Return cleanup function from useEffect

Export functions:
- `checkForUpdates`: Invokes 'update:check' channel
- `downloadUpdate`: Invokes 'update:download' channel
- `dismiss`: Resets state to idle

Return value: `{ status, version, progress, error, checkForUpdates, downloadUpdate, dismiss }`

IMPORTANT: Use `isElectron()` from `src/utils/platform.ts` for environment check. Return early if not Electron.
  </action>
  <verify>
1. File exists at src/hooks/useUpdateEvents.ts
2. `npm run build` passes
3. Hook exports `useUpdateEvents` function
  </verify>
  <done>
Hook exists, exports correctly, handles all update event types, returns cleanup function for memory safety.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create UpdateNotification component and integrate</name>
  <files>src/components/UpdateNotification.tsx, src/App.tsx</files>
  <action>
Create `UpdateNotification.tsx` following the existing toast pattern from App.tsx:515-570.

Component requirements:
1. Use `useUpdateEvents` hook
2. Position: `absolute top-20 left-1/2 transform -translate-x-1/2 z-50` (matches import toast)
3. Only render when status is 'available', 'downloading', 'ready', or 'error'
4. Return null for 'idle', 'checking', 'notAvailable'

UI states:
- **available**: Blue background (bg-blue-600), show version, "Download" button
- **downloading**: Blue background, show progress percentage (use progress bar or text)
- **ready**: Green background (bg-emerald-600), "Restart to Install" message
- **error**: Red background (bg-red-600), show error message, dismiss button

Include dismiss button (X) on all states except 'downloading'.

In App.tsx:
1. Import `UpdateNotification` from `./components/UpdateNotification`
2. Add `<UpdateNotification />` after the SaveIndicator and before the import feedback message (around line 514)
3. DO NOT add any hook calls to App.tsx - the component is self-contained

Styling: Use Tailwind classes matching the import feedback toast (rounded-lg, shadow-lg, px-6 py-3, flex items-center gap-3).
  </action>
  <verify>
1. Files exist at src/components/UpdateNotification.tsx
2. `npm run build` passes
3. `npm run dev` starts without errors
4. In Electron dev mode (`npm run dev:electron`), no console errors from update subscription
  </verify>
  <done>
UpdateNotification component renders appropriate UI for each update state. Component is integrated in App.tsx and renders in correct position.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. `npm run lint` passes
3. `npm run test` passes (no new test requirements, existing tests should pass)
4. `npm run dev:electron` starts without console errors
5. TypeScript IntelliSense shows `onUpdateEvent` on `window.electronAPI`
</verification>

<success_criteria>
- Type definitions added to both declaration files with matching signatures
- useUpdateEvents hook created with proper cleanup
- UpdateNotification component created with all state handling
- App.tsx integrates the component
- No TypeScript errors
- No console errors in Electron dev mode
</success_criteria>

<output>
After completion, create `.planning/phases/06-update-ui-completion/06-01-SUMMARY.md`
</output>
