---
phase: 02-file-operations-menus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - electron/main/ipc/fileHandlers.ts
  - electron/main/index.ts
  - electron/preload/index.ts
  - electron/preload/index.d.ts
autonomous: true

must_haves:
  truths:
    - "User can open file dialog and select JSON family tree files"
    - "User can save family tree to disk via native Save dialog"
    - "User can choose a new location via Save As dialog"
    - "User sees error message when opening invalid JSON files"
  artifacts:
    - path: "electron/main/ipc/fileHandlers.ts"
      provides: "IPC handlers for file dialogs"
      exports: ["registerFileHandlers"]
    - path: "electron/preload/index.ts"
      provides: "Extended allowlist with file dialog channels"
      contains: "dialog:open"
    - path: "electron/preload/index.d.ts"
      provides: "TypeScript types for file operations"
      contains: "OpenFileResult"
  key_links:
    - from: "electron/main/index.ts"
      to: "electron/main/ipc/fileHandlers.ts"
      via: "registerFileHandlers() call in app.whenReady"
      pattern: "registerFileHandlers\\(\\)"
    - from: "electron/preload/index.ts"
      to: "electron/main/ipc/fileHandlers.ts"
      via: "channel allowlist matching handler names"
      pattern: "dialog:open.*dialog:save.*dialog:saveAs"
---

<objective>
Implement IPC file dialog handlers in main process and extend preload script for file operations.

Purpose: Establish the main process infrastructure for native file dialogs that Phase 1 prepared the security foundation for. This enables the renderer to open/save family tree JSON files through secure IPC.

Output:
- `electron/main/ipc/fileHandlers.ts` with dialog:open, dialog:save, dialog:saveAs handlers
- Extended preload allowlist and TypeScript types
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-operations-menus/02-RESEARCH.md
@.planning/phases/02-file-operations-menus/02-CONTEXT.md

# Existing files to extend
@electron/main/index.ts
@electron/preload/index.ts
@electron/preload/index.d.ts

# Data models for file format validation
@src/models/FamilyMember.ts
@src/models/Relationship.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IPC File Dialog Handlers</name>
  <files>electron/main/ipc/fileHandlers.ts, electron/main/index.ts</files>
  <action>
Create `electron/main/ipc/fileHandlers.ts` with three IPC handlers:

1. **dialog:open** handler:
   - Use `dialog.showOpenDialog` with parent window from `BrowserWindow.fromWebContents(event.sender)`
   - Default path: `app.getPath('documents')`
   - Filter to JSON files: `{ name: 'JSON Files', extensions: ['json'] }`
   - Read file with `fs.readFile(filePath, 'utf-8')`
   - Parse JSON in try/catch, return error object if invalid
   - Validate structure: must have `members` array (basic validation)
   - Return type: `{ canceled: boolean, data: unknown | null, filePath: string | null, error?: string }`

2. **dialog:save** handler:
   - Accept `{ data: unknown, filePath: string | null }` argument
   - If no filePath provided, show save dialog first (first save)
   - If filePath provided, overwrite silently (subsequent saves)
   - Default filename: `Untitled.json`
   - Write with `fs.writeFile(path, JSON.stringify(data, null, 2), 'utf-8')`
   - Return type: `{ canceled: boolean, filePath: string | null }`

3. **dialog:saveAs** handler:
   - Accept `{ data: unknown, defaultPath?: string }` argument
   - Always show save dialog (even if filePath known)
   - Suggest current filename in dialog if defaultPath provided
   - Return type: `{ canceled: boolean, filePath: string | null }`

Export a `registerFileHandlers()` function that registers all three handlers with `ipcMain.handle()`.

Update `electron/main/index.ts`:
- Import `registerFileHandlers` from './ipc/fileHandlers'
- Call `registerFileHandlers()` in `app.whenReady()` before `createWindow()`

Use async/await throughout. Never use sync methods (no `showSaveDialogSync`).
  </action>
  <verify>
Run `npm run build` - TypeScript compiles without errors.
Verify file created at `electron/main/ipc/fileHandlers.ts`.
Verify `electron/main/index.ts` imports and calls `registerFileHandlers()`.
  </verify>
  <done>
Three IPC handlers registered: dialog:open, dialog:save, dialog:saveAs.
Main process can show native file dialogs and read/write JSON files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend Preload Script and Types</name>
  <files>electron/preload/index.ts, electron/preload/index.d.ts</files>
  <action>
Update `electron/preload/index.ts`:

1. Add file dialog channels to `ALLOWED_CHANNELS` array:
   - 'dialog:open'
   - 'dialog:save'
   - 'dialog:saveAs'

2. Add new `ALLOWED_RECEIVE_CHANNELS` array for menu events:
   - 'menu:new'
   - 'menu:open'
   - 'menu:save'
   - 'menu:saveAs'
   - 'menu:export'

3. Add `onMenuAction` method to electronAPI with COMPLETE implementation:

```typescript
const ALLOWED_RECEIVE_CHANNELS = [
  'menu:new',
  'menu:open',
  'menu:save',
  'menu:saveAs',
  'menu:export'
] as const

const electronAPI = {
  isElectron: true,
  invoke: (channel: string, ...args: unknown[]) => {
    if (ALLOWED_CHANNELS.includes(channel)) {
      return ipcRenderer.invoke(channel, ...args)
    }
    throw new Error(`Invalid channel: ${channel}`)
  },
  onMenuAction: (callback: (action: string) => void): (() => void) => {
    // Create listeners for each allowed receive channel
    const listeners: Array<{ channel: string; handler: (_event: Electron.IpcRendererEvent) => void }> = []

    for (const channel of ALLOWED_RECEIVE_CHANNELS) {
      const handler = (_event: Electron.IpcRendererEvent) => {
        // Extract action name from channel (e.g., 'menu:save' -> 'save')
        const action = channel.replace('menu:', '')
        callback(action)
      }
      ipcRenderer.on(channel, handler)
      listeners.push({ channel, handler })
    }

    // Return unsubscribe function
    return () => {
      for (const { channel, handler } of listeners) {
        ipcRenderer.removeListener(channel, handler)
      }
    }
  }
}

contextBridge.exposeInMainWorld('electronAPI', electronAPI)
```

Update `electron/preload/index.d.ts`:

1. Add result type interfaces:
   ```typescript
   interface OpenFileResult {
     canceled: boolean
     data: unknown | null
     filePath: string | null
     error?: string
   }

   interface SaveFileResult {
     canceled: boolean
     filePath: string | null
   }
   ```

2. Extend ElectronAPI interface:
   - Keep existing `isElectron` and `invoke`
   - Add `onMenuAction: (callback: (action: string) => void) => () => void`

3. Export the result type interfaces so renderer can import them.
  </action>
  <verify>
Run `npm run build` - TypeScript compiles without errors.
Check `ALLOWED_CHANNELS` includes 'dialog:open', 'dialog:save', 'dialog:saveAs'.
Check `ALLOWED_RECEIVE_CHANNELS` includes all menu channels.
Check `onMenuAction` has full implementation with unsubscribe function.
Check types export `OpenFileResult` and `SaveFileResult`.
  </verify>
  <done>
Preload script exposes file dialog channels through secure allowlist.
Menu event listener with proper unsubscribe pattern.
TypeScript types available for type-safe IPC calls in renderer.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify IPC Communication End-to-End</name>
  <files>None (verification only)</files>
  <action>
Run the Electron app in dev mode and verify IPC handlers work:

1. Start app: `npm run dev`
2. Open DevTools (Cmd+Option+I or Ctrl+Shift+I)
3. In Console, test each IPC channel:

```javascript
// Test dialog:open
await window.electronAPI.invoke('dialog:open')
// Expected: Native file dialog opens, returns { canceled: true/false, data, filePath }

// Test dialog:save (should prompt since no filePath)
await window.electronAPI.invoke('dialog:save', { data: { test: true }, filePath: null })
// Expected: Native save dialog opens

// Test dialog:saveAs
await window.electronAPI.invoke('dialog:saveAs', { data: { test: true }, defaultPath: 'test.json' })
// Expected: Native save dialog opens with 'test.json' suggested
```

4. Verify invalid channel still throws:
```javascript
await window.electronAPI.invoke('not-allowed-channel')
// Expected: Error "Invalid channel: not-allowed-channel"
```

5. Test onMenuAction subscription:
```javascript
const unsubscribe = window.electronAPI.onMenuAction(action => console.log('Menu action:', action))
// Expected: Returns a function
typeof unsubscribe === 'function'  // true
```

If any test fails, debug and fix before completing.
  </action>
  <verify>
All three dialog IPC calls work from DevTools console.
Native dialogs appear and return expected result objects.
Invalid channels still throw security error.
onMenuAction returns unsubscribe function.
  </verify>
  <done>
IPC file handlers verified working end-to-end.
Security allowlist still enforced for other channels.
Menu action listener pattern verified.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without TypeScript errors
2. `npm run dev` starts Electron app without errors
3. DevTools console IPC tests all pass
4. Native file dialogs appear on macOS/Windows/Linux
5. File read/write works with valid JSON
6. Invalid JSON returns error object (not crash)
7. onMenuAction sets up listeners for all menu channels
</verification>

<success_criteria>
- Three IPC handlers (dialog:open, dialog:save, dialog:saveAs) registered in main process
- Preload allowlist extended with file dialog channels
- ALLOWED_RECEIVE_CHANNELS defined for menu events
- onMenuAction implemented with full listener setup and unsubscribe
- TypeScript types exported for OpenFileResult and SaveFileResult
- IPC calls work from renderer DevTools console
- Security allowlist still blocks unauthorized channels
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-operations-menus/02-01-SUMMARY.md`
</output>
