---
phase: 02-file-operations-menus
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - electron/main/index.ts
  - electron/preload/index.ts
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Close with unsaved changes shows confirmation dialog"
    - "User sees dirty indicator in window title when changes exist"
    - "macOS shows dot in close button when document is dirty"
    - "Saving clears the dirty indicator"
  artifacts:
    - path: "electron/main/index.ts"
      provides: "Dirty state tracking and close confirmation"
      contains: "setDocumentEdited"
    - path: "electron/preload/index.ts"
      provides: "document:setDirty channel in allowlist"
      contains: "document:setDirty"
  key_links:
    - from: "src/App.tsx"
      to: "window.electronAPI"
      via: "invoke document:setDirty when isDirty changes"
      pattern: "invoke.*document:setDirty"
    - from: "electron/main/index.ts"
      to: "mainWindow.setDocumentEdited"
      via: "dirty state tracking on macOS"
      pattern: "setDocumentEdited\\("
---

<objective>
Implement dirty state tracking with window title indicator and close confirmation for unsaved changes.

Purpose: Protect users from accidentally losing unsaved work. Show visual indicator when changes exist, and prompt before closing with unsaved changes.

Output:
- Dirty state IPC handlers in main process
- Close confirmation dialog when dirty
- Window title indicator (asterisk on Windows/Linux, dot on macOS)
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-operations-menus/02-RESEARCH.md
@.planning/phases/02-file-operations-menus/02-CONTEXT.md

# Prior plan summaries
@.planning/phases/02-file-operations-menus/02-01-SUMMARY.md
@.planning/phases/02-file-operations-menus/02-02-SUMMARY.md
@.planning/phases/02-file-operations-menus/02-03-SUMMARY.md

# Files to extend
@electron/main/index.ts
@electron/preload/index.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dirty State IPC Handlers and Close Confirmation</name>
  <files>electron/main/index.ts, electron/preload/index.ts</files>
  <action>
**Update `electron/main/index.ts`:**

Add dirty state tracking and close confirmation. Place this code AFTER the mainWindow is created:

```typescript
import * as path from 'path'

// Module-level state for dirty tracking
let isDirty = false
let currentFilePath: string | null = null

// Inside app.whenReady(), after createWindow():
function setupDirtyStateHandling() {
  // Register IPC handlers for dirty state
  ipcMain.handle('document:setDirty', (_event, dirty: boolean, filePath: string | null) => {
    isDirty = dirty
    currentFilePath = filePath

    if (mainWindow) {
      // macOS: dot in close button when document is edited
      mainWindow.setDocumentEdited(dirty)

      // Update window title with dirty indicator
      const baseName = filePath
        ? path.basename(filePath)
        : 'Untitled'
      // macOS uses the close button dot, so no asterisk needed
      // Windows/Linux show asterisk in title
      const indicator = process.platform === 'darwin' ? '' : (dirty ? ' *' : '')
      mainWindow.setTitle(`${baseName}${indicator} - Ancestree`)
    }

    return true
  })

  ipcMain.handle('document:getDirty', () => isDirty)

  // Handle window close with unsaved changes confirmation
  mainWindow!.on('close', async (event) => {
    if (!isDirty) return // Allow close if no unsaved changes

    event.preventDefault()

    const result = await dialog.showMessageBox(mainWindow!, {
      type: 'question',
      buttons: ['Save', "Don't Save", 'Cancel'],
      defaultId: 0,
      cancelId: 2,
      title: 'Unsaved Changes',
      message: 'Do you want to save changes?',
      detail: 'Your changes will be lost if you close without saving.'
    })

    if (result.response === 0) {
      // Save - send to renderer, renderer will save then close
      mainWindow!.webContents.send('menu:save')
      // After save completes, renderer should call window.close() again
      // Note: renderer needs to set isDirty=false after successful save
    } else if (result.response === 1) {
      // Don't Save - force close by clearing dirty flag first
      isDirty = false
      mainWindow!.close()
    }
    // Cancel (response === 2): do nothing, keep window open
  })
}

// Call this function after createWindow() in app.whenReady():
// createWindow()
// setupDirtyStateHandling()
```

**Update `electron/preload/index.ts`:**

Add dirty state channels to `ALLOWED_CHANNELS`:

```typescript
const ALLOWED_CHANNELS = [
  'dialog:open',
  'dialog:save',
  'dialog:saveAs',
  'dialog:export',
  'autosave:get',
  'autosave:clear',
  'autosave:has',
  'autosave:update',
  'document:setDirty',   // Add this
  'document:getDirty'    // Add this
] as const
```
  </action>
  <verify>
`npm run build` passes.
`electron/main/index.ts` has `document:setDirty` and `document:getDirty` handlers.
`electron/main/index.ts` has close event handler with confirmation dialog.
`electron/preload/index.ts` ALLOWED_CHANNELS includes document:setDirty and document:getDirty.
  </verify>
  <done>
Dirty state IPC handlers registered.
Close confirmation dialog shows when dirty.
Window title updates with dirty indicator.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Dirty State from App.tsx to Main Process</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to sync dirty state with main process when it changes:

```typescript
import { useEffect } from 'react'
import { isElectron } from './utils/platform'

// Add this useEffect to sync dirty state with main process
// Place after the useFileOperations hook call:

useEffect(() => {
  if (!isElectron()) return

  // Sync dirty state to main process for window title and close confirmation
  window.electronAPI!.invoke('document:setDirty', fileOps.isDirty, fileOps.filePath)
}, [fileOps.isDirty, fileOps.filePath])

// Also update the markDirty call when tree data changes:
useEffect(() => {
  // When tree state changes (after initial load), mark as dirty
  // Skip on initial mount to avoid marking new files as dirty immediately
  const isInitialState = /* check if this is initial empty state */

  if (!isInitialState) {
    fileOps.markDirty()
    fileOps.updateAutoSave(/* tree state */)
  }
}, [/* tree state dependencies */])
```

**Key points:**
1. When `fileOps.isDirty` changes, notify main process via `document:setDirty`
2. Pass both the dirty flag and current filePath (for title display)
3. Main process will update window title and enable/disable close confirmation
4. After successful save, useFileOperations already sets isDirty=false, which triggers this sync

**After save completes and closes window:**
The renderer's save handler should call `window.close()` after successful save when the close confirmation requested it. Since dirty state is now false, the close will proceed.
  </action>
  <verify>
`npm run build` passes.
App.tsx has useEffect that calls `document:setDirty` when isDirty changes.
Dirty state sync happens on both isDirty and filePath changes.
  </verify>
  <done>
Dirty state synced from React hook to main process.
Window title and close button reflect current dirty state.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 file operations and menu system:
- Native file dialogs (Open, Save, Save As, Export)
- Application menu with keyboard shortcuts
- Dirty state indicator (dot on macOS, asterisk on Win/Linux)
- Close confirmation for unsaved changes
- GEDCOM export
- Auto-save crash recovery
  </what-built>
  <how-to-verify>
1. Start the app: `npm run dev`

2. **Test Dirty State Indicator:**
   - Open DevTools console
   - Run: `await window.electronAPI.invoke('document:setDirty', true, null)`
   - macOS: close button should show dot indicator
   - Windows/Linux: title should show asterisk (e.g., "Untitled * - Ancestree")
   - Run: `await window.electronAPI.invoke('document:setDirty', false, null)`
   - Indicator should disappear

3. **Test Close Confirmation:**
   - Set dirty state: `await window.electronAPI.invoke('document:setDirty', true, null)`
   - Try to close window (click X or Cmd+W)
   - Should show dialog: "Do you want to save changes?" with Save / Don't Save / Cancel
   - Click Cancel - window stays open
   - Try again, click Don't Save - window closes without saving

4. **Test File Operations:**
   - Press Cmd/Ctrl+N (New) - should reset to untitled state
   - Press Cmd/Ctrl+O (Open) - native dialog should appear
   - Press Cmd/Ctrl+S (Save) - on first save, prompts for location
   - Press Cmd/Ctrl+Shift+S (Save As) - always prompts
   - File > Export - should offer GEDCOM (.ged) format

5. **Test Menus:**
   - macOS: "Ancestree" in menu bar with About, Hide, Quit
   - Cmd+Q (macOS) or Alt+F4 (Windows/Linux) quits app
   - All keyboard shortcuts work

6. **Verify Web Mode:**
   - Open http://localhost:5173 in browser
   - App loads without errors (file operations gracefully disabled)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Dirty state syncs from React to main process
3. Window title shows dirty indicator on all platforms
4. macOS close button shows dot when dirty
5. Close confirmation prevents accidental data loss
6. Save clears dirty state (and indicator)
7. Web mode continues to work
</verification>

<success_criteria>
- Dirty state tracked and displayed in window (asterisk on Win/Linux, dot on macOS)
- Close confirmation appears with unsaved changes
- Save/Don't Save/Cancel all work correctly
- After save, dirty indicator clears
- Phase 2 success criteria from roadmap met:
  1. User can save family tree via native Save dialog
  2. User can open family tree via native Open dialog
  3. File menu has New, Open, Save, Save As, Export, Quit
  4. Cmd/Ctrl+S saves, Cmd/Ctrl+O opens, Cmd/Ctrl+Q quits
  5. macOS shows "Ancestree" in menu bar with standard items
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-operations-menus/02-05-SUMMARY.md`
</output>
