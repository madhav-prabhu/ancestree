---
phase: 08-fix-ui-bugs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Relationships persist correctly when opening a saved file in Electron"
    - "Relationships persist correctly when recovering from crash draft"
    - "No relationships are lost during file open operations"
  artifacts:
    - path: "src/App.tsx"
      provides: "ID-mapped relationship import for file open and draft recovery"
      contains: "idMapping"
  key_links:
    - from: "src/App.tsx (open handler)"
      to: "addRelationship()"
      via: "ID mapping from old to new member IDs"
      pattern: "idMapping\\.get"
---

<objective>
Fix the relationship import bug in Electron file operations.

Purpose: When opening a saved file or recovering from a crash draft, relationships are lost because the import code creates new member IDs without mapping the old relationship references. The `importFromJson()` utility already handles this correctly, but the Electron `menu:open` handler and crash recovery in `App.tsx` bypass it.

Output: Updated App.tsx with proper ID mapping for relationship import in both the open handler and draft recovery flow.
</objective>

<execution_context>
@/home/madhav/.claude/get-shit-done/workflows/execute-plan.md
@/home/madhav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-fix-ui-bugs/08-RESEARCH.md

Key files:
@src/App.tsx (lines 114-136 for open handler, lines 191-214 for draft recovery)
@src/utils/importUtils.ts (lines 186-237 for working ID mapping pattern)
@src/models/Relationship.ts (RelationshipType definition)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix relationship import in Electron open handler</name>
  <files>src/App.tsx</files>
  <action>
  Update the `case 'open':` handler (around lines 114-136) to properly import relationships using ID mapping.

  Current broken code:
  ```typescript
  for (const member of fileData.members || []) {
    await addMember({...})
  }
  // Note: Relationships would need ID mapping - for now skip
  ```

  Replace with ID-mapped import:
  1. Create `idMapping = new Map<string, string>()` before the member loop
  2. For each member added, store `idMapping.set(member.id, newMember.id)`
  3. After members, loop through `fileData.relationships || []`
  4. For each relationship, get mapped IDs: `newPerson1Id = idMapping.get(rel.person1Id)`
  5. If both IDs map successfully, call `addRelationship(rel.type, newPerson1Id, newPerson2Id, metadata)`
  6. Wrap relationship creation in try/catch to handle duplicates gracefully (some may be auto-created)
  7. Remove the "Note: Relationships would need ID mapping" comment

  Pattern to follow (from importUtils.ts):
  ```typescript
  const idMapping = new Map<string, string>()
  for (const member of fileData.members || []) {
    const newMember = await addMember({
      name: member.name,
      dateOfBirth: member.dateOfBirth,
      placeOfBirth: member.placeOfBirth,
      dateOfDeath: member.dateOfDeath,
      notes: member.notes,
      photo: member.photo,
    })
    idMapping.set(member.id, newMember.id)
  }

  for (const rel of fileData.relationships || []) {
    const newPerson1Id = idMapping.get(rel.person1Id)
    const newPerson2Id = idMapping.get(rel.person2Id)
    if (newPerson1Id && newPerson2Id) {
      try {
        await addRelationship(
          rel.type,
          newPerson1Id,
          newPerson2Id,
          rel.marriageDate || rel.divorceDate ? { marriageDate: rel.marriageDate, divorceDate: rel.divorceDate } : undefined
        )
      } catch {
        // Skip duplicates (some relationships auto-created by addRelationship logic)
      }
    }
  }
  ```
  </action>
  <verify>
  1. `npm run build` passes without TypeScript errors
  2. `npm run lint` passes
  </verify>
  <done>
  The open handler creates ID mapping and imports both members AND relationships from opened files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix relationship import in crash recovery flow</name>
  <files>src/App.tsx</files>
  <action>
  Apply the same ID mapping fix to the draft recovery code (around lines 191-214).

  Current broken code:
  ```typescript
  for (const member of draftData.members || []) {
    await addMember({...})
  }
  // No relationship import at all
  ```

  Update to use ID mapping pattern identical to Task 1:
  1. Create `idMapping = new Map<string, string>()` before member loop
  2. Store old->new ID mapping as members are added
  3. Loop through `draftData.relationships || []` and import with mapped IDs
  4. Wrap in try/catch for duplicate handling

  Note: Draft data structure matches file data structure (both are `{ members, relationships }`).
  </action>
  <verify>
  1. `npm run build` passes
  2. `npm run test` passes (existing tests should not break)
  </verify>
  <done>
  Draft recovery preserves relationships when recovering from crash.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Build passes: `npm run build`
2. Tests pass: `npm run test`
3. Lint passes: `npm run lint`
4. Code review: Verify both `idMapping` patterns are consistent
</verification>

<success_criteria>
- Build, test, and lint all pass
- Both open handler and draft recovery use ID mapping
- No "Relationships would need ID mapping" TODO comment remains
- Relationships are imported alongside members in both flows
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-ui-bugs/08-01-SUMMARY.md`
</output>
